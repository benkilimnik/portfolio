
# Design
This multi-threaded proxy acts as a MySQL database while interfacing with a GDPR-compliant database called Pelton. Queries are converted to C compatible types and sent to Pelton. Responses are converted to rust compatible types and returned. Any application that uses a MySQL backend may connect to this proxy instead of a traditional database.

![mysql_proxy](https://user-images.githubusercontent.com/47846691/142962769-038774df-5d8b-4b2f-b345-700e87d24eb9.png)
![Pelton Diagrams SYMPOSIUM drawio](https://user-images.githubusercontent.com/47846691/142964194-1c480262-49ef-4bba-828e-8a5865416441.png)


- Flow:  
Application <=> Mysql Proxy <=> FFI <=> Pelton API (C++)

# Code
- `mysql_proxy/src/main.rs` contains the code to start the proxy
- `<bazel-bin>/mysql_proxy/src/proxy_ffi.rs` contains the FFI interface with C (automatically generated by bazel)
- `mysql_proxy/src/proxy_wrappers.rs` contains functions which convert rust types to C, call the appropriate FFI functions into pelton, and return the response to the proxy
- `mysql_proxy/src/ffi/ffi.h` contains the C/C++ API for the rust proxy. Its functions convert C++ types to C and pass query responses to rust via the FFI.  

# Quickstart

Steps to start:
1. __First time only:__ setup cargo-raze and use it to setup the bazel layout for
rust dependencies declared in Cargo.toml.
```bash
cargo install cargo-raze
cd <pelton_root>/mysql_proxy
cargo raze
cd <pelton_root>
```

2. Run with compiler optimizations
```bash
bazel run //mysql_proxy/src:mysql_proxy --config=opt
```

3. Connect to the proxy using a mariadb client (from another terminal).
```bash
mariadb --port=10001 --host=127.0.0.1
```

# Debugging
- Run with rust debug info
```bash
bazel run //mysql_proxy/src:mysql_proxy
```

- Run with rust backtracing enabled
```bash
RUST_BACKTRACE=1 bazel run //mysql_proxy/src:mysql_proxy
```

- Run with FFI debug info
```bash
bazel run //mysql_proxy/src:mysql_proxy -- -logtostderr=1
```

- Run with valgrind (asan)
```bash
bazel run --run_under "valgrind --error-exitcode=1 --errors-for-leak-kinds=definite --leak-check=full --show-leak-kinds=definite" //mysql_proxy/src:mysql_proxy
```

- Run with thread sanitizer. (requires switching to rust nightly compiler)
1. In `mysql_proxy/BUILD.bazel`  
    a. Add 
    ```bazel
    "-Zsanitizer=thread",
    ```  
    to `rustc_flags=[...]` of `rust_binary(name="mysql_proxy"...)`
    b. Add 
    ```bazel
    rustc_flags = [
         "-Zsanitizer=thread",
    ],
    ```
    to `rust_library(name="proxy_ffi"...)`  

    2. Switch to rust nightly by adding 
    ```bazel
    rust_repositories(
    iso_date = "2021-06-16",
    version = "nightly",
    )
    ```
    to `WORKSPACE.bazel`

    3. run with tsan
    ```bash
    bazel run //mysql_proxy/src:mysql_proxy --config=tsan
    ```
